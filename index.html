<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд Трафика | Deep Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #1a1e24;
            --card-bg: #22262b;
            --text-main: #f0f4f8; 
            --text-secondary: #a0a8b5; 
            --border-color: #353a41;
            --accent-main: #6b84f9;
            --accent-main-dark: #4a67e6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --gradient-accent: linear-gradient(135deg, var(--accent-main) 0%, var(--accent-main-dark) 100%);
            --shadow-soft: 5px 5px 10px rgba(0, 0, 0, 0.4), -5px -5px 10px rgba(45, 52, 60, 0.2);
            --shadow-hover: 0 10px 25px rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            margin: 0;
            padding: 30px;
        }

        .container { max-width: 1400px; margin: 0 auto; }
        header { margin-bottom: 40px; }
        
        h1 { 
            font-size: 2.2rem; 
            font-weight: 800; 
            margin: 0; 
            letter-spacing: -1px;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: var(--shadow-soft); 
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border-color);
        }

        .filters {
            display: flex;
            gap: 20px;
            padding: 20px 30px; 
            border-radius: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: var(--card-bg);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; }
        
        select, input[type="date"] { 
            padding: 10px 14px; 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            font-size: 0.95rem; 
            min-width: 160px; 
            background-color: var(--primary-bg); 
            color: var(--text-main);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-title { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--accent-main); }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        .chart-container { height: 400px; }

        .table-container { 
            background: var(--card-bg); 
            border-radius: 16px; 
            border: 1px solid var(--border-color); 
            overflow: hidden; 
        }
        table { width: 100%; border-collapse: collapse; color: var(--text-main); }
        th { background-color: #2d3138; padding: 15px 20px; text-align: left; font-size: 0.85rem; color: var(--text-secondary); }
        td { padding: 15px 20px; border-bottom: 1px solid #2d3138; }
        
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .bg-green { background: #10b98133; color: var(--accent-success); border: 1px solid var(--accent-success); }
        .bg-yellow { background: #f59e0b33; color: var(--accent-warning); border: 1px solid var(--accent-warning); }
        .bg-red { background: #ef444433; color: var(--accent-danger); border: 1px solid var(--accent-danger); }
        .bg-gray { background: #a0a8b533; color: var(--text-secondary); }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-bg); display: flex; justify-content: center;
            align-items: center; z-index: 9999; font-size: 1.2rem;
        }
    </style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">Синхронизация с данными Google Sheets...</div>

<div class="container" id="dashboard-content" style="display:none;">
    <header>
        <h1>Анализ Трафика | Deep Analytics Dashboard</h1>
    </header>

    <section class="filters">
        <div class="filter-group">
            <label>Команда</label>
            <select id="teamSelect"><option value="all">Все команды</option></select>
        </div>
        <div class="filter-group">
            <label>Сотрудник</label>
            <select id="employeeSelect"><option value="all">Все сотрудники</option></select>
        </div>
        <div class="filter-group">
            <label>Страна (ГЕО)</label>
            <select id="countrySelect"><option value="all">Все страны</option></select>
        </div>
        <div class="filter-group">
            <label>Метрика</label>
            <select id="metricSelect">
                <option value="spend">Расход ($)</option>
                <option value="leads">Лиды</option>
                <option value="cpl">CPL ($)</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Период</label>
            <div style="display:flex; gap:10px;">
                <input type="date" id="startDate">
                <input type="date" id="endDate">
            </div>
        </div>
    </section>

    <section class="kpi-grid">
        <div class="card"><div class="kpi-title">Расход (USD)</div><div class="kpi-value" id="totalSpend">$0</div></div>
        <div class="card"><div class="kpi-title">Лиды</div><div class="kpi-value" id="totalLeads">0</div></div>
        <div class="card"><div class="kpi-title">Средний CPL</div><div class="kpi-value" id="avgCpl">$0.00</div></div>
        <div class="card"><div class="kpi-title">Активных ГЕО</div><div class="kpi-value" id="activeGeo">0</div></div>
    </section>

    <section class="charts-grid">
        <div class="chart-container card"><canvas id="mainBarChart"></canvas></div>
        <div class="chart-container card"><canvas id="pieChart"></canvas></div>
    </section>

    <section class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Сотрудник</th>
                    <th>Команда</th>
                    <th>Страны</th>
                    <th>Расход ($)</th>
                    <th>Лиды</th>
                    <th>CPL ($)</th>
                    <th>Эффективность</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </section>
</div>

<script>
    const SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/1J71fRlx7NrEICL8Ah8gPKDmOKf2QSiMkeKnY8-O6yrw/gviz/tq?tqx=out:csv&gid=0';
    
    let rawData = [];
    let state = { team: 'all', employee: 'all', country: 'all', metric: 'spend', startDate: '', endDate: '' };
    let charts = { bar: null, pie: null };

    // Настройка индексов колонок согласно твоему скриншоту
    const INDEX = { DATE: 0, TEAM: 2, EMP: 3, COUNTRY: 5, SPEND: 8, LEADS: 9, CPL: 10 };

    async function fetchData() {
        try {
            const response = await fetch(SHEETS_CSV_URL);
            const csvText = await response.text();
            rawData = parseCSV(csvText);
            initDashboard();
        } catch (e) {
            document.getElementById('loading-overlay').innerText = "Ошибка доступа к данным";
        }
    }

    function parseCSV(csv) {
        const lines = csv.split('\n').filter(l => l.trim() !== '');
        return lines.slice(1).map(line => {
            const cols = line.match(/(?:"[^"]*"|[^,])+/g).map(c => c.replace(/^"|"$/g, '').trim());
            return {
                date: normalizeDate(cols[INDEX.DATE]),
                team: cols[INDEX.TEAM] || 'N/A',
                employee: cols[INDEX.EMP] || 'N/A',
                country: cols[INDEX.COUNTRY] || 'N/A',
                spend: parseFloat(cols[INDEX.SPEND].replace(/\s/g, '').replace(',', '.')) || 0,
                leads: Math.round(parseFloat(cols[INDEX.LEADS]) || 0),
                cpl: parseFloat(cols[INDEX.CPL].replace(',', '.')) || 0
            };
        }).filter(d => d.spend > 0 || d.leads > 0);
    }

    function normalizeDate(d) {
        const p = d.match(/(\d{1,2})[./](\d{1,2})[./](\d{4})/);
        return p ? `${p[3]}-${p[2].padStart(2,'0')}-${p[1].padStart(2,'0')}` : null;
    }

    function initDashboard() {
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
        
        populateFilter('teamSelect', 'team');
        updateSecondaryFilters();
        
        const triggers = ['teamSelect', 'employeeSelect', 'countrySelect', 'metricSelect', 'startDate', 'endDate'];
        triggers.forEach(id => document.getElementById(id).addEventListener('change', (e) => {
            state[id.replace('Select', '').replace('Filter', '')] = e.target.value;
            if(id === 'teamSelect') updateSecondaryFilters();
            updateDashboard();
        }));

        updateDashboard();
    }

    function populateFilter(id, key, data = rawData) {
        const el = document.getElementById(id);
        const current = el.value;
        const items = [...new Set(data.map(d => d[key]))].filter(Boolean).sort();
        el.innerHTML = `<option value="all">Все ${id.includes('country') ? 'страны' : (id.includes('team') ? 'команды' : 'сотрудники')}</option>`;
        items.forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
        el.value = items.includes(current) ? current : 'all';
    }

    function updateSecondaryFilters() {
        const filteredByTeam = state.team === 'all' ? rawData : rawData.filter(d => d.team === state.team);
        populateFilter('employeeSelect', 'employee', filteredByTeam);
        populateFilter('countrySelect', 'country', filteredByTeam);
    }

    function updateDashboard() {
        const filtered = rawData.filter(d => {
            const mTeam = state.team === 'all' || d.team === state.team;
            const mEmp = state.employee === 'all' || d.employee === state.employee;
            const mCountry = state.country === 'all' || d.country === state.country;
            let mDate = true;
            if(state.startDate && d.date < state.startDate) mDate = false;
            if(state.endDate && d.date > state.endDate) mDate = false;
            return mTeam && mEmp && mCountry && mDate;
        });

        // KPI
        const totalSpend = filtered.reduce((s, d) => s + d.spend, 0);
        const totalLeads = filtered.reduce((s, d) => s + d.leads, 0);
        document.getElementById('totalSpend').innerText = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(totalSpend);
        document.getElementById('totalLeads').innerText = totalLeads;
        document.getElementById('avgCpl').innerText = totalLeads > 0 ? `$${(totalSpend/totalLeads).toFixed(2)}` : '$0.00';
        document.getElementById('activeGeo').innerText = new Set(filtered.map(d => d.country)).size;

        // Группировка для таблицы
        const summary = {};
        filtered.forEach(d => {
            if(!summary[d.employee]) summary[d.employee] = { emp: d.employee, team: d.team, spend: 0, leads: 0, geos: new Set() };
            summary[d.employee].spend += d.spend;
            summary[d.employee].leads += d.leads;
            summary[d.employee].geos.add(d.country);
        });

        const list = Object.values(summary).sort((a,b) => b[state.metric] - a[state.metric]);
        
        renderCharts(list, filtered);
        renderTable(list);
    }

    function renderCharts(list, filtered) {
        const barCtx = document.getElementById('mainBarChart').getContext('2d');
        const pieCtx = document.getElementById('pieChart').getContext('2d');

        if(charts.bar) charts.bar.destroy();
        if(charts.pie) charts.pie.destroy();

        // Bar Chart (Топ сотрудников)
        charts.bar = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: list.slice(0, 10).map(i => i.emp),
                datasets: [{
                    label: state.metric === 'spend' ? 'Расход ($)' : 'Лиды',
                    data: list.slice(0, 10).map(i => state.metric === 'cpl' ? (i.spend/i.leads || 0) : i[state.metric]),
                    backgroundColor: '#6b84f9', borderRadius: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'ТОП-10 Сотрудников' }}}
        });

        // Pie Chart (Расходы по Странам)
        const geoStats = {};
        filtered.forEach(d => { geoStats[d.country] = (geoStats[d.country] || 0) + d.spend; });

        charts.pie = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(geoStats),
                datasets: [{ data: Object.values(geoStats), backgroundColor: ['#6b84f9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Распределение бюджета по ГЕО' }}}
        });
    }

    function renderTable(list) {
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        list.forEach(row => {
            const cpl = row.leads > 0 ? (row.spend/row.leads) : 0;
            let status = cpl <= 0.25 ? 'bg-green' : (cpl <= 0.35 ? 'bg-yellow' : 'bg-red');
            let statusText = cpl <= 0.25 ? 'Отлично' : (cpl <= 0.35 ? 'Средне' : 'Высокий CPL');
            if(row.leads === 0) { status = 'bg-red'; statusText = 'Нет лидов'; }

            body.innerHTML += `
                <tr>
                    <td style="font-weight:600">${row.emp}</td>
                    <td>${row.team}</td>
                    <td style="color:var(--text-secondary); font-size:0.8rem">${Array.from(row.geos).join(', ')}</td>
                    <td>$${row.spend.toFixed(2)}</td>
                    <td>${row.leads}</td>
                    <td>$${cpl.toFixed(2)}</td>
                    <td><span class="status-badge ${status}">${statusText}</span></td>
                </tr>
            `;
        });
    }

    fetchData();
</script>
</body>
</html>
