<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Analytics | Deep Drilldown Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #f5f7fb; --card-bg: #ffffff; --text-main: #1e293b; 
            --text-secondary: #64748b; --border-color: #e2e8f0; --accent-main: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        [data-theme="dark"] {
            --primary-bg: #1a1e24; --card-bg: #22262b; --text-main: #f0f4f8; 
            --text-secondary: #a0a8b5; --border-color: #353a41; --accent-main: #6b84f9;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--primary-bg); color: var(--text-main); margin: 0; padding: 30px; transition: all 0.3s ease; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 2rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, #1e293b 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .theme-toggle { background: var(--accent-main); color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; border: none; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 20px; }
        .filters { display: flex; gap: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 0.7rem; color: var(--text-secondary); font-weight: 800; text-transform: uppercase; }
        select, input { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--primary-bg); color: var(--text-main); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--accent-main); }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--primary-bg); padding: 15px; text-align: left; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .nested-row { display: none; background: var(--primary-bg); }
        .campaign-row { background: var(--card-bg) !important; font-size: 0.8rem; font-style: italic; color: var(--text-secondary); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; }
        .bg-green { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid #10b981; }
        .bg-red { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Анализ Трафика | Deep Analytics</h1>
        <button class="theme-toggle" id="themeBtn">Сменить тему</button>
    </header>

    <section class="card filters">
        <div class="filter-group"><label>Команда</label><select id="teamSelect"><option value="all">Все</option></select></div>
        <div class="filter-group"><label>Сотрудник</label><select id="employeeSelect"><option value="all">Все</option></select></div>
        <div class="filter-group"><label>Метрика</label><select id="metricSelect"><option value="spend">Расход ($)</option><option value="leads">Лиды</option></select></div>
        <div class="filter-group"><label>Дата</label><input type="date" id="startDate"></div>
    </section>

    <div class="kpi-grid">
        <div class="card"><div class="kpi-title">Расход</div><div class="kpi-value" id="totalSpend">$0</div></div>
        <div class="card"><div class="kpi-title">Лиды</div><div class="kpi-value" id="totalLeads">0</div></div>
        <div class="card"><div class="kpi-title">Средний CPL</div><div class="kpi-value" id="avgCpl">$0.00</div></div>
    </div>

    <div class="card">
        <table id="mainTable">
            <thead>
                <tr>
                    <th>Сотрудник</th>
                    <th>Команда</th>
                    <th>Расход ($)</th>
                    <th>Лиды</th>
                    <th>CPL ($)</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1J71fRlx7NrEICL8Ah8gPKDmOKf2QSiMkeKnY8-O6yrw/gviz/tq?tqx=out:csv&gid=0';
    const COL = { DATE: 0, TEAM: 2, EMP: 3, GEO: 5, CAMP: 6, SPEND: 8, LEADS: 9 }; // Колонки из твоей таблицы
    
    let rawData = [];
    let state = { team: 'all', employee: 'all', metric: 'spend', startDate: '' };

    document.getElementById('themeBtn').onclick = () => {
        const root = document.documentElement;
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
    };

    async function load() {
        const res = await fetch(SHEETS_URL);
        const text = await res.text();
        rawData = text.split('\n').slice(1).map(line => {
            const c = line.match(/(?:"[^"]*"|[^,])+/g).map(v => v.replace(/^"|"$/g, '').trim());
            return {
                date: c[COL.DATE], team: c[COL.TEAM], emp: c[COL.EMP], 
                geo: c[COL.GEO], camp: c[COL.CAMP], 
                spend: parseFloat(c[COL.SPEND]?.replace(/\s/g, '').replace(',', '.')) || 0,
                leads: parseInt(c[COL.LEADS]) || 0
            };
        }).filter(d => d.spend > 0);
        
        populateFilter('teamSelect', 'team');
        update();
    }

    function populateFilter(id, key) {
        const items = [...new Set(rawData.map(d => d[key]))].sort();
        items.forEach(i => document.getElementById(id).innerHTML += `<option value="${i}">${i}</option>`);
    }

    function update() {
        const filtered = rawData.filter(d => {
            return (state.team === 'all' || d.team === state.team) &&
                   (state.employee === 'all' || d.emp === state.employee);
        });

        const sumSpend = filtered.reduce((a, b) => a + b.spend, 0);
        const sumLeads = filtered.reduce((a, b) => a + b.leads, 0);
        document.getElementById('totalSpend').innerText = `$${sumSpend.toFixed(2)}`;
        document.getElementById('totalLeads').innerText = sumLeads;
        document.getElementById('avgCpl').innerText = `$${(sumSpend/(sumLeads || 1)).toFixed(2)}`;

        render(filtered);
    }

    function render(data) {
        const body = document.getElementById('tableBody');
        body.innerHTML = '';

        // Группировка: Сотрудник -> ГЕО -> Кампания
        const tree = {};
        data.forEach(d => {
            if(!tree[d.emp]) tree[d.emp] = { spend: 0, leads: 0, team: d.team, geos: {} };
            tree[d.emp].spend += d.spend;
            tree[d.emp].leads += d.leads;

            if(!tree[d.emp].geos[d.geo]) tree[d.emp].geos[d.geo] = { spend: 0, leads: 0, camps: {} };
            tree[d.emp].geos[d.geo].spend += d.spend;
            tree[d.emp].geos[d.geo].leads += d.leads;

            if(!tree[d.emp].geos[d.geo].camps[d.camp]) tree[d.emp].geos[d.geo].camps[d.camp] = { spend: 0, leads: 0 };
            tree[d.emp].geos[d.geo].camps[d.camp].spend += d.spend;
            tree[d.emp].geos[d.geo].camps[d.camp].leads += d.leads;
        });

        Object.entries(tree).forEach(([emp, d]) => {
            const cpl = d.spend / (d.leads || 1);
            const row = document.createElement('tr');
            row.innerHTML = `<td><b>▶ ${emp}</b></td><td>${d.team}</td><td>$${d.spend.toFixed(2)}</td><td>${d.leads}</td><td>$${cpl.toFixed(2)}</td><td><span class="status-badge ${cpl < 0.3 ? 'bg-green' : 'bg-red'}">${cpl < 0.3 ? 'OK' : 'HIGH'}</span></td>`;
            row.onclick = () => toggle(emp);
            body.appendChild(row);

            // Строки ГЕО
            Object.entries(d.geos).forEach(([geo, g]) => {
                const geoRow = document.createElement('tr');
                geoRow.className = `nested-row emp-${emp}`;
                geoRow.innerHTML = `<td style="padding-left:40px">○ ${geo}</td><td>-</td><td>$${g.spend.toFixed(2)}</td><td>${g.leads}</td><td>$${(g.spend/(g.leads||1)).toFixed(2)}</td><td>-</td>`;
                geoRow.onclick = (e) => { e.stopPropagation(); toggle(`${emp}-${geo}`); };
                body.appendChild(geoRow);

                // Строки Кампаний
                Object.entries(g.camps).forEach(([camp, c]) => {
                    const campRow = document.createElement('tr');
                    campRow.className = `nested-row campaign-row emp-${emp}-${geo}`;
                    campRow.innerHTML = `<td style="padding-left:80px">ID: ${camp}</td><td>-</td><td>$${c.spend.toFixed(2)}</td><td>${c.leads}</td><td>$${(c.spend/(c.leads||1)).toFixed(2)}</td><td>-</td>`;
                    body.appendChild(campRow);
                });
            });
        });
    }

    function toggle(id) {
        const rows = document.querySelectorAll(`.emp-${id}`);
        rows.forEach(r => r.style.display = r.style.display === 'table-row' ? 'none' : 'table-row');
    }

    document.querySelectorAll('select').forEach(s => s.onchange = (e) => { state[e.target.id.replace('Select','')] = e.target.value; update(); });
    load();
</script>
</body>
</html>
