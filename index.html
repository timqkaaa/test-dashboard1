<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Analytics | Dashboard with CPC</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #f5f7fb; --card-bg: #ffffff; --text-main: #1e293b; 
            --text-secondary: #64748b; --border-color: #e2e8f0; --accent-main: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --header-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        }
        [data-theme="dark"] {
            --primary-bg: #1a1e24; --card-bg: #22262b; --text-main: #f0f4f8; 
            --text-secondary: #a0a8b5; --border-color: #353a41; --accent-main: #6b84f9;
            --shadow: 5px 5px 15px rgba(0, 0, 0, 0.4);
            --header-gradient: linear-gradient(135deg, #6b84f9 0%, #4a67e6 100%);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--primary-bg); color: var(--text-main); margin: 0; padding: 30px; transition: all 0.3s ease; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 2rem; font-weight: 800; margin: 0; letter-spacing: -1px; background: var(--header-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .theme-toggle { background: var(--accent-main); color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 0.85rem; border: 2px solid rgba(255, 255, 255, 0.2); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); transition: all 0.2s ease; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .filters { display: flex; gap: 15px; padding: 20px; border-radius: 16px; margin-bottom: 30px; flex-wrap: wrap; background: var(--card-bg); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 0.7rem; color: var(--text-secondary); font-weight: 800; text-transform: uppercase; }
        select, input[type="date"] { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 0.9rem; background-color: var(--primary-bg); color: var(--text-main); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--accent-main); }
        .table-container { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: var(--primary-bg); padding: 15px 20px; text-align: left; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; }
        .bg-green { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid #10b981; }
        .bg-yellow { background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid #f59e0b; }
        .bg-red { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid #ef4444; }
        .details-row { background-color: var(--primary-bg); }
        .details-table { width: 100%; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); margin: 10px 0; }
        .details-table td { background: var(--card-bg); font-size: 0.85rem; padding: 12px; border-bottom: 1px solid var(--border-color); }
        .camp-row { background-color: var(--primary-bg) !important; display: none; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-bg); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">Добавляем CPC в аналитику...</div>

<div class="container" id="dashboard-content" style="display:none;">
    <header>
        <h1>Анализ Трафика | Analytics</h1>
        <button class="theme-toggle" id="themeBtn">Сменить тему</button>
    </header>

    <section class="filters">
        <div class="filter-group"><label>Команда</label><select id="teamSelect"><option value="all">Все</option></select></div>
        <div class="filter-group"><label>Сотрудник</label><select id="employeeSelect"><option value="all">Все</option></select></div>
        <div class="filter-group"><label>Страна</label><select id="countrySelect"><option value="all">Все</option></select></div>
        <div class="filter-group"><label>Период</label>
            <div style="display:flex; gap:8px;"><input type="date" id="startDate"><input type="date" id="endDate"></div>
        </div>
    </section>

    <div class="kpi-grid">
        <div class="card"><div class="kpi-title">Расход</div><div class="kpi-value" id="totalSpend">$0</div></div>
        <div class="card"><div class="kpi-title">Лиды</div><div class="kpi-value" id="totalLeads">0</div></div>
        <div class="card"><div class="kpi-title">Средний CPL</div><div class="kpi-value" id="avgCpl">$0.00</div></div>
        <div class="card"><div class="kpi-title">Средний CPC</div><div class="kpi-value" id="avgCpc">$0.00</div></div>
    </div>

    <section class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Сотрудник / ГЕО</th>
                    <th>Команда</th>
                    <th>Расход ($)</th>
                    <th>Лиды</th>
                    <th>CPL ($)</th>
                    <th>CPC ($)</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </section>
</div>

<script>
    const SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/1J71fRlx7NrEICL8Ah8gPKDmOKf2QSiMkeKnY8-O6yrw/gviz/tq?tqx=out:csv&gid=0';
    // Обновленные индексы: 8-Расход, 9-Лиды, 10-CPC (колонка K)
    const INDEX = { DATE: 0, TEAM: 2, EMP: 3, COUNTRY: 5, CAMPAIGN: 6, SPEND: 8, LEADS: 9, CPC: 10 };
    
    let rawData = [];
    let state = { team: 'all', employee: 'all', country: 'all', startDate: '', endDate: '' };

    themeBtn.onclick = () => {
        const root = document.documentElement;
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        updateDashboard();
    };

    async function fetchData() {
        try {
            const response = await fetch(SHEETS_CSV_URL);
            const csvText = await response.text();
            rawData = parseCSV(csvText);
            initDashboard();
        } catch (e) { console.error(e); }
    }

    function parseCSV(csv) {
        const lines = csv.split('\n').filter(l => l.trim() !== '');
        return lines.slice(1).map(line => {
            const cols = line.match(/(?:"[^"]*"|[^,])+/g).map(c => c.replace(/^"|"$/g, '').trim());
            return {
                date: normalizeDate(cols[INDEX.DATE]),
                team: cols[INDEX.TEAM] || 'N/A',
                employee: cols[INDEX.EMP] || 'N/A',
                country: cols[INDEX.COUNTRY] || 'N/A',
                campaign: cols[INDEX.CAMPAIGN] || 'N/A',
                spend: parseFloat(cols[INDEX.SPEND]?.replace(/\s/g, '').replace(',', '.')) || 0,
                leads: Math.round(parseFloat(cols[INDEX.LEADS]) || 0),
                cpc: parseFloat(cols[INDEX.CPC]?.replace(/\s/g, '').replace(',', '.')) || 0
            };
        }).filter(d => d.spend > 0);
    }

    function normalizeDate(d) {
        const p = d?.match(/(\d{1,2})[./](\d{1,2})[./](\d{4})/);
        return p ? `${p[3]}-${p[2].padStart(2,'0')}-${p[1].padStart(2,'0')}` : null;
    }

    function initDashboard() {
        document.getElementById('loading-overlay').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
        populateFilter('teamSelect', 'team');
        updateSecondaryFilters();
        ['teamSelect', 'employeeSelect', 'countrySelect', 'startDate', 'endDate'].forEach(id => {
            document.getElementById(id).addEventListener('change', (e) => {
                state[id.replace('Select', '')] = e.target.value;
                if(id === 'teamSelect') updateSecondaryFilters();
                updateDashboard();
            });
        });
        updateDashboard();
    }

    function populateFilter(id, key, data = rawData) {
        const el = document.getElementById(id);
        const items = [...new Set(data.map(d => d[key]))].filter(Boolean).sort();
        el.innerHTML = `<option value="all">Все</option>`;
        items.forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
    }

    function updateSecondaryFilters() {
        const filtered = state.team === 'all' ? rawData : rawData.filter(d => d.team === state.team);
        populateFilter('employeeSelect', 'employee', filtered);
        populateFilter('countrySelect', 'country', filtered);
    }

    function updateDashboard() {
        const filtered = rawData.filter(d => {
            const mTeam = state.team === 'all' || d.team === state.team;
            const mEmp = state.employee === 'all' || d.employee === state.employee;
            const mCountry = state.country === 'all' || d.country === state.country;
            let mDate = true;
            if(state.startDate && d.date < state.startDate) mDate = false;
            if(state.endDate && d.date > state.endDate) mDate = false;
            return mTeam && mEmp && mCountry && mDate;
        });

        const totalSpend = filtered.reduce((s, d) => s + d.spend, 0);
        const totalLeads = filtered.reduce((s, d) => s + d.leads, 0);
        const avgCpc = filtered.length > 0 ? (filtered.reduce((s, d) => s + d.cpc, 0) / filtered.length) : 0;

        document.getElementById('totalSpend').innerText = `$${totalSpend.toLocaleString()}`;
        document.getElementById('totalLeads').innerText = totalLeads;
        document.getElementById('avgCpl').innerText = totalLeads > 0 ? `$${(totalSpend/totalLeads).toFixed(2)}` : '$0.00';
        document.getElementById('avgCpc').innerText = `$${avgCpc.toFixed(2)}`;

        const summary = {};
        filtered.forEach(d => {
            if(!summary[d.employee]) summary[d.employee] = { emp: d.employee, team: d.team, spend: 0, leads: 0, cpcSum: 0, count: 0, countries: {} };
            summary[d.employee].spend += d.spend;
            summary[d.employee].leads += d.leads;
            summary[d.employee].cpcSum += d.cpc;
            summary[d.employee].count++;

            if(!summary[d.employee].countries[d.country]) summary[d.employee].countries[d.country] = { spend: 0, leads: 0, cpcSum: 0, count: 0, campaigns: {} };
            summary[d.employee].countries[d.country].spend += d.spend;
            summary[d.employee].countries[d.country].leads += d.leads;
            summary[d.employee].countries[d.country].cpcSum += d.cpc;
            summary[d.employee].countries[d.country].count++;

            if(!summary[d.employee].countries[d.country].campaigns[d.campaign]) summary[d.employee].countries[d.country].campaigns[d.campaign] = { spend: 0, leads: 0, cpc: d.cpc };
            summary[d.employee].countries[d.country].campaigns[d.campaign].spend += d.spend;
            summary[d.employee].countries[d.country].campaigns[d.campaign].leads += d.leads;
        });

        renderTable(Object.values(summary).sort((a,b) => b.spend - a.spend));
    }

    function renderTable(list) {
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        list.forEach((row, rowIndex) => {
            const cpl = row.leads > 0 ? (row.spend/row.leads) : 0;
            const cpc = row.cpcSum / row.count;
            const status = cpl <= 0.35 ? 'bg-green' : 'bg-red';
            
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.innerHTML = `
                <td><span class="toggle-icon" style="color:var(--accent-main); margin-right:8px;">▶</span><b>${row.emp}</b></td>
                <td>${row.team}</td>
                <td><b>$${row.spend.toFixed(2)}</b></td>
                <td>${row.leads}</td>
                <td>$${cpl.toFixed(2)}</td>
                <td>$${cpc.toFixed(2)}</td>
                <td><span class="status-badge ${status}">${cpl <= 0.35 ? 'OK' : 'HIGH'}</span></td>
            `;

            const detTr = document.createElement('tr');
            detTr.className = 'details-row'; detTr.style.display = 'none';
            let detHtml = `<td colspan="7" style="padding:0 40px 15px 40px"><table class="details-table"><thead><tr><th>ГЕО</th><th>Расход</th><th>Лиды</th><th>CPL</th><th>CPC</th></tr></thead><tbody>`;
            
            Object.entries(row.countries).forEach(([geo, gData], geoIdx) => {
                const geoId = `geo-${rowIndex}-${geoIdx}`;
                const gCpc = gData.cpcSum / gData.count;
                detHtml += `
                    <tr style="cursor:pointer" onclick="toggleCampaigns('${geoId}')">
                        <td><span class="geo-icon-${geoId}" style="margin-right:5px">▶</span>${geo}</td>
                        <td>$${gData.spend.toFixed(2)}</td><td>${gData.leads}</td>
                        <td>$${(gData.leads > 0 ? gData.spend/gData.leads : 0).toFixed(2)}</td>
                        <td>$${gCpc.toFixed(2)}</td>
                    </tr>
                    <tr id="${geoId}" class="camp-row"><td colspan="5" style="padding: 5px 20px">
                        <table style="width:100%; font-size:0.75rem; border:1px dashed var(--border-color)">
                            <tr style="background:var(--primary-bg)"><th>№ Компании</th><th>Расход</th><th>Лиды</th><th>CPL</th><th>CPC</th></tr>
                            ${Object.entries(gData.campaigns).map(([camp, cData]) => `
                                <tr><td>${camp}</td><td>$${cData.spend.toFixed(2)}</td><td>${cData.leads}</td><td>$${(cData.leads > 0 ? cData.spend/cData.leads : 0).toFixed(2)}</td><td>$${cData.cpc.toFixed(2)}</td></tr>
                            `).join('')}
                        </table>
                    </td></tr>`;
            });
            detTr.innerHTML = detHtml + `</tbody></table></td>`;
            tr.onclick = () => {
                const isHid = detTr.style.display === 'none';
                detTr.style.display = isHid ? 'table-row' : 'none';
                tr.querySelector('.toggle-icon').innerText = isHid ? '▼' : '▶';
            };
            body.appendChild(tr); body.appendChild(detTr);
        });
    }

    function toggleCampaigns(id) {
        const row = document.getElementById(id);
        const icon = document.querySelector(`.geo-icon-${id}`);
        const isHid = row.style.display === 'none' || row.style.display === '';
        row.style.display = isHid ? 'table-row' : 'none';
        icon.innerText = isHid ? '▼' : '▶';
        event.stopPropagation();
    }
    fetchData();
</script>
</body>
</html>
