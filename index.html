<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Analytics | Full Drilldown Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #f5f7fb; --card-bg: #ffffff; --text-main: #1e293b; 
            --text-secondary: #64748b; --border-color: #e2e8f0; --accent-main: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        [data-theme="dark"] {
            --primary-bg: #1a1e24; --card-bg: #22262b; --text-main: #f0f4f8; 
            --text-secondary: #a0a8b5; --border-color: #353a41; --accent-main: #6b84f9;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--primary-bg); color: var(--text-main); margin: 0; padding: 30px; transition: all 0.3s ease; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 2rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, #1e293b 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .theme-toggle { background: var(--accent-main); color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: 700; border: none; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 20px; }
        .filters { display: flex; gap: 15px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 0.7rem; color: var(--text-secondary); font-weight: 800; text-transform: uppercase; }
        select, input { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--primary-bg); color: var(--text-main); min-width: 150px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--accent-main); }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 25px; margin-bottom: 35px; }
        .chart-container { height: 400px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--primary-bg); padding: 15px; text-align: left; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .nested-row { display: none; background: var(--primary-bg); }
        .campaign-row { display: none; background: var(--card-bg) !important; font-size: 0.85rem; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; }
        .bg-green { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid #10b981; }
        .bg-red { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-bg); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">Восстановление графиков...</div>

<div class="container" id="dashboard-content" style="display:none;">
    <header>
        <h1>Анализ Трафика | Deep Analytics</h1>
        <button class="theme-toggle" id="themeBtn">Сменить тему</button>
    </header>

    <section class="card filters">
        <div class="filter-group"><label>Команда</label><select id="teamSelect"><option value="all">Все</option></select></div>
        <div class="filter-group"><label>Сотрудник</label><select id="employeeSelect"><option value="all">Все</option></select></div>
        <div class="filter-group"><label>Метрика</label><select id="metricSelect">
            <option value="spend">Расход ($)</option><option value="leads">Лиды</option>
        </select></div>
        <div class="filter-group"><label>Дата</label><input type="date" id="startDate"></div>
    </section>

    <div class="kpi-grid">
        <div class="card"><div class="kpi-title">Расход</div><div class="kpi-value" id="totalSpend">$0</div></div>
        <div class="card"><div class="kpi-title">Лиды</div><div class="kpi-value" id="totalLeads">0</div></div>
        <div class="card"><div class="kpi-title">Средний CPL</div><div class="kpi-value" id="avgCpl">$0.00</div></div>
    </div>

    <section class="charts-grid">
        <div class="chart-container card"><canvas id="mainBarChart"></canvas></div>
        <div class="chart-container card"><canvas id="pieChart"></canvas></div>
    </section>

    <div class="card" style="overflow-x: auto;">
        <table id="mainTable">
            <thead>
                <tr>
                    <th>Сотрудник / ГЕО / Кампания</th>
                    <th>Команда</th>
                    <th>Расход ($)</th>
                    <th>Лиды</th>
                    <th>CPL ($)</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1J71fRlx7NrEICL8Ah8gPKDmOKf2QSiMkeKnY8-O6yrw/gviz/tq?tqx=out:csv&gid=0';
    const COL = { DATE: 0, TEAM: 2, EMP: 3, GEO: 5, CAMP: 6, SPEND: 8, LEADS: 9 };
    
    let rawData = [];
    let state = { team: 'all', employee: 'all', metric: 'spend', startDate: '' };
    let charts = { bar: null, pie: null };

    document.getElementById('themeBtn').onclick = () => {
        const root = document.documentElement;
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        update(); 
    };

    async function load() {
        try {
            const res = await fetch(SHEETS_URL);
            const text = await res.text();
            rawData = text.split('\n').slice(1).map(line => {
                const c = line.match(/(?:"[^"]*"|[^,])+/g).map(v => v.replace(/^"|"$/g, '').trim());
                if (c.length < 10) return null;
                return {
                    date: normalizeDate(c[COL.DATE]), team: c[COL.TEAM], emp: c[COL.EMP], 
                    geo: c[COL.GEO], camp: c[COL.CAMP], 
                    spend: parseFloat(c[COL.SPEND]?.replace(/\s/g, '').replace(',', '.')) || 0,
                    leads: parseInt(c[COL.LEADS]) || 0
                };
            }).filter(d => d && d.spend > 0);
            
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            
            populateFilter('teamSelect', 'team');
            updateSecondaryFilters();

            const triggers = ['teamSelect', 'employeeSelect', 'metricSelect', 'startDate'];
            triggers.forEach(id => document.getElementById(id).addEventListener('change', (e) => {
                state[id.replace('Select', '')] = e.target.value;
                if(id === 'teamSelect') updateSecondaryFilters();
                update();
            }));

            update();
        } catch (e) { document.getElementById('loading-overlay').innerText = "Ошибка загрузки данных"; }
    }

    function normalizeDate(d) {
        const p = d?.match(/(\d{1,2})[./](\d{1,2})[./](\d{4})/);
        return p ? `${p[3]}-${p[2].padStart(2,'0')}-${p[1].padStart(2,'0')}` : null;
    }

    function populateFilter(id, key, data = rawData) {
        const el = document.getElementById(id);
        const current = el.value;
        const items = [...new Set(data.map(d => d[key]))].filter(Boolean).sort();
        el.innerHTML = `<option value="all">Все</option>`;
        items.forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
        if (items.includes(current)) el.value = current;
    }

    function updateSecondaryFilters() {
        const filtered = state.team === 'all' ? rawData : rawData.filter(d => d.team === state.team);
        populateFilter('employeeSelect', 'emp', filtered);
    }

    function update() {
        const filtered = rawData.filter(d => {
            const mTeam = state.team === 'all' || d.team === state.team;
            const mEmp = state.employee === 'all' || d.emp === state.employee;
            const mDate = !state.startDate || d.date === state.startDate;
            return mTeam && mEmp && mDate;
        });

        const sumSpend = filtered.reduce((a, b) => a + b.spend, 0);
        const sumLeads = filtered.reduce((a, b) => a + b.leads, 0);
        document.getElementById('totalSpend').innerText = `$${sumSpend.toLocaleString()}`;
        document.getElementById('totalLeads').innerText = sumLeads;
        document.getElementById('avgCpl').innerText = `$${(sumSpend/(sumLeads || 1)).toFixed(2)}`;

        const summary = aggregate(filtered);
        renderCharts(summary, filtered);
        renderTable(summary);
    }

    function aggregate(data) {
        const tree = {};
        data.forEach(d => {
            if(!tree[d.emp]) tree[d.emp] = { spend: 0, leads: 0, team: d.team, geos: {} };
            tree[d.emp].spend += d.spend;
            tree[d.emp].leads += d.leads;

            if(!tree[d.emp].geos[d.geo]) tree[d.emp].geos[d.geo] = { spend: 0, leads: 0, camps: {} };
            tree[d.emp].geos[d.geo].spend += d.spend;
            tree[d.emp].geos[d.geo].leads += d.leads;

            if(!tree[d.emp].geos[d.geo].camps[d.camp]) tree[d.emp].geos[d.geo].camps[d.camp] = { spend: 0, leads: 0 };
            tree[d.emp].geos[d.geo].camps[d.camp].spend += d.spend;
            tree[d.emp].geos[d.geo].camps[d.camp].leads += d.leads;
        });
        return tree;
    }

    function renderCharts(summary, filtered) {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const color = isDark ? '#f0f4f8' : '#1e293b';
        Chart.defaults.color = color;

        if(charts.bar) charts.bar.destroy();
        if(charts.pie) charts.pie.destroy();

        const sortedEmp = Object.entries(summary).sort((a,b) => b[1].spend - a[1].spend).slice(0, 10);

        charts.bar = new Chart(document.getElementById('mainBarChart'), {
            type: 'bar',
            data: {
                labels: sortedEmp.map(e => e[0]),
                datasets: [{ label: 'Расход ($)', data: sortedEmp.map(e => e[1].spend), backgroundColor: '#6b84f9', borderRadius: 8 }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const geoStats = {};
        filtered.forEach(d => { geoStats[d.geo] = (geoStats[d.geo] || 0) + d.spend; });
        charts.pie = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(geoStats),
                datasets: [{ data: Object.values(geoStats), backgroundColor: ['#6b84f9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderTable(tree) {
        const body = document.getElementById('tableBody');
        body.innerHTML = '';

        Object.entries(tree).forEach(([emp, d]) => {
            const cpl = d.spend / (d.leads || 1);
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.innerHTML = `<td><b>▶ ${emp}</b></td><td>${d.team}</td><td>$${d.spend.toFixed(2)}</td><td>${d.leads}</td><td>$${cpl.toFixed(2)}</td><td><span class="status-badge ${cpl < 0.35 ? 'bg-green' : 'bg-red'}">${cpl < 0.35 ? 'OK' : 'HIGH'}</span></td>`;
            row.onclick = () => toggleClass(`emp-${emp.replace(/\s/g, '')}`);
            body.appendChild(row);

            Object.entries(d.geos).forEach(([geo, g]) => {
                const geoRow = document.createElement('tr');
                geoRow.className = `nested-row emp-${emp.replace(/\s/g, '')}`;
                geoRow.style.cursor = 'pointer';
                geoRow.innerHTML = `<td style="padding-left:30px">▼ ${geo}</td><td>-</td><td>$${g.spend.toFixed(2)}</td><td>${g.leads}</td><td>$${(g.spend/(g.leads||1)).toFixed(2)}</td><td>-</td>`;
                geoRow.onclick = (e) => { e.stopPropagation(); toggleClass(`camp-${emp.replace(/\s/g, '')}-${geo.replace(/\s/g, '')}`); };
                body.appendChild(geoRow);

                Object.entries(g.camps).forEach(([camp, c]) => {
                    const campRow = document.createElement('tr');
                    campRow.className = `nested-row campaign-row camp-${emp.replace(/\s/g, '')}-${geo.replace(/\s/g, '')}`;
                    campRow.innerHTML = `<td style="padding-left:60px; color:var(--text-secondary)">ID: ${camp}</td><td>-</td><td>$${c.spend.toFixed(2)}</td><td>${c.leads}</td><td>$${(c.spend/(c.leads||1)).toFixed(2)}</td><td>-</td>`;
                    body.appendChild(campRow);
                });
            });
        });
    }

    function toggleClass(cls) {
        const rows = document.getElementsByClassName(cls);
        for (let r of rows) {
            r.style.display = r.style.display === 'table-row' ? 'none' : 'table-row';
            if (r.style.display === 'none' && r.className.includes('nested-row')) {
                const subCls = r.onclick ? r.onclick.toString().match(/'(.*?)'/)[1] : null;
                if(subCls) {
                    const subs = document.getElementsByClassName(subCls);
                    for(let s of subs) s.style.display = 'none';
                }
            }
        }
    }

    load();
</script>
</body>
</html>
