<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд Трафика: Soft Neumorphism Dark (Исправлено)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Soft Dark Theme Variables */
            --primary-bg: #1a1e24; /* Мягкий темный фон */
            --card-bg: #22262b; /* Фон карточек (чуть светлее фона) */
            --text-main: #f0f4f8; 
            --text-secondary: #a0a8b5; 
            --border-color: #353a41; /* Мягкие разделители */
            
            /* Accent Colors */
            --accent-main: #6b84f9; /* Мягкий, но яркий синий */
            --accent-main-dark: #4a67e6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;

            --gradient-accent: linear-gradient(135deg, var(--accent-main) 0%, var(--accent-main-dark) 100%);
            /* Глубокая, мягкая тень для эффекта приподнятости */
            --shadow-soft: 
                5px 5px 10px rgba(0, 0, 0, 0.4), 
                -5px -5px 10px rgba(45, 52, 60, 0.2);
            --shadow-hover: 0 10px 25px rgba(0, 0, 0, 0.7);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-main);
            margin: 0;
            padding: 30px;
        }

        .container { max-width: 1400px; margin: 0 auto; }
        header { margin-bottom: 40px; }
        
        /* Typography */
        h1 { 
            font-size: 2.2rem; 
            font-weight: 800; 
            margin: 0; 
            letter-spacing: -1px;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h3 { font-size: 1.4rem; font-weight: 700; margin: 0; color: var(--text-main); }

        /* General Card Styling */
        .card {
            background: var(--card-bg);
            border-radius: 16px; 
            padding: 30px; 
            box-shadow: var(--shadow-soft); 
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border-color);
        }
        .card:hover {
            transform: translateY(-5px); 
            box-shadow: var(--shadow-hover);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 20px;
            padding: 20px 30px; 
            border-radius: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: var(--card-bg);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.95rem; color: var(--text-secondary); font-weight: 600; }
        
        select, input[type="date"] { 
            padding: 10px 14px; 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            font-size: 1rem; 
            min-width: 180px; 
            background-color: var(--primary-bg); 
            color: var(--text-main);
            transition: border-color 0.2s, background-color 0.2s;
        }
        select:hover, input[type="date"]:hover {
            border-color: var(--accent-main);
        }
        select:focus, input[type="date"]:focus {
            border-color: var(--accent-main);
            outline: none;
            box-shadow: 0 0 0 3px rgba(107, 132, 249, 0.3);
        }
        .date-range-group { display: flex; gap: 10px; }
        
        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .kpi-title { font-size: 1rem; color: var(--text-secondary); margin-bottom: 15px; }
        .kpi-value { 
            font-size: 2.8rem; 
            font-weight: 800; 
            color: var(--accent-main); 
            letter-spacing: -0.05em;
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        .chart-container { height: 450px; }

        /* Data Table */
        .table-container { 
            background: var(--card-bg); 
            border-radius: 16px; 
            box-shadow: var(--shadow-soft); 
            overflow: hidden; 
            border: 1px solid var(--border-color); 
        }
        .table-header { padding: 30px; border-bottom: 1px solid var(--border-color); }
        table { color: var(--text-main); }
        th, td { 
            padding: 20px 30px; 
            border-bottom: 1px solid #2d3138; 
        }
        th { 
            background-color: #2d3138; 
            font-weight: 700; 
            color: var(--text-secondary); 
            font-size: 0.9rem;
        }
        tr:hover {
            background-color: #2d3138;
        }
        
        /* Status indicators */
        .status-badge { 
            padding: 7px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }
        
        .bg-green { background-color: #10b98133; color: var(--accent-success); border: 1px solid var(--accent-success); }
        .bg-yellow { background-color: #f59e0b33; color: var(--accent-warning); border: 1px solid var(--accent-warning); }
        .bg-red { background-color: #ef444433; color: var(--accent-danger); border: 1px solid var(--accent-danger); }
        .bg-gray { background-color: #a0a8b533; color: var(--text-secondary); border: 1px solid var(--text-secondary); }

        /* Loading Overlay */
        .loading-overlay {
            background: rgba(26, 30, 36, 0.95);
            color: var(--text-main);
        }
    </style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">Загрузка данных из Google Sheets...</div>

<div class="container" style="display:none;" id="dashboard-content">
    <header>
        <h1>Анализ Трафика | Deep Analytics Dashboard</h1>
    </header>

    <section class="filters">
        <div class="filter-group">
            <label>Команда</label>
            <select id="teamSelect">
                <option value="all">Все команды</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Сотрудник</label>
            <select id="employeeSelect">
                <option value="all">Все сотрудники</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Метрика для графика</label>
            <select id="metricSelect">
                <option value="spend">Расход ($)</option>
                <option value="leads">Лиды</option>
                <option value="cpl">CPL ($)</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Диапазон дат</label>
            <div class="date-range-group">
                <input type="date" id="startDate" title="Начальная дата">
                <input type="date" id="endDate" title="Конечная дата">
            </div>
        </div>
    </section>

    <section class="kpi-grid">
        <div class="card">
            <div class="kpi-title">Общий расход (USD)</div>
            <div class="kpi-value" id="totalSpend">$0</div>
        </div>
        <div class="card">
            <div class="kpi-title">Всего лидов</div>
            <div class="kpi-value" id="totalLeads">0</div>
        </div>
        <div class="card">
            <div class="kpi-title">Средний CPL</div>
            <div class="kpi-value" id="avgCpl">$0.00</div>
        </div>
        <div class="card">
            <div class="kpi-title">Активных сотрудников</div>
            <div class="kpi-value" id="activeEmployees">0</div>
        </div>
    </section>

    <section class="charts-grid">
        <div class="chart-container card">
            <canvas id="mainBarChart"></canvas>
        </div>
        <div class="chart-container card">
            <canvas id="pieChart"></canvas>
        </div>
    </section>

    <section class="table-container">
        <div class="table-header">
            <h3 id="tableTitle">Сводная детализация по сотрудникам</h3>
        </div>
        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Сотрудник</th>
                        <th>Команда</th>
                        <th>Расход ($)</th>
                        <th>Лиды</th>
                        <th>CPL ($)</th>
                        <th>Период активности</th>
                        <th>Эффективность</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </section>
</div>

<script>
    // ⚠️ АКТУАЛЬНЫЙ URL: Обновлен на основе предоставленной ссылки
    const SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/1o8fa3ih85cDkAUJFXV4l0kzMwrv7V2zlcIzO8x3UITk/gviz/tq?tqx=out:csv&gid=0';
    const UPDATE_INTERVAL_MS = 300000; // 5 минут

    let rawData = [];
    let state = {
        team: 'all',
        employee: 'all',
        metric: 'spend',
        startDate: '',
        endDate: ''
    };
    let barChartInstance = null;
    let pieChartInstance = null;
    const teamSelect = document.getElementById('teamSelect');
    const employeeSelect = document.getElementById('employeeSelect');
    const metricSelect = document.getElementById('metricSelect');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const loadingOverlay = document.getElementById('loading-overlay');
    const dashboardContent = document.getElementById('dashboard-content');
    const tableTitle = document.getElementById('tableTitle');

    // Глобальные настройки Chart.js для темного режима
    Chart.defaults.color = '#a0a8b5';
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.layout.padding = 10;
    Chart.defaults.plugins.title.color = '#f0f4f8';
    Chart.defaults.plugins.legend.labels.color = '#f0f4f8';

    function normalizeDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.match(/(\d{1,2})[./](\d{1,2})[./](\d{4})/);
        if (parts) {
            const year = parts[3];
            const month = parts[2].padStart(2, '0');
            const day = parts[1].padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        return dateStr;
    }

    // --- ИСПРАВЛЕННАЯ ФУНКЦИЯ csvToJSON С УСИЛЕННЫМ ПАРСИНГОМ ЧИСЕЛ ---
    function csvToJSON(csv) {
        const lines = csv.split('\n').filter(line => line.trim() !== '');
        
        const INDEX_DATE = 0;       
        const INDEX_TEAM = 2;       
        const INDEX_EMPLOYEE = 3;   
        const INDEX_SPEND = 8;      
        const INDEX_LEADS = 9;      
        const INDEX_CPL = 10;

        const result = [];
        
        for (let i = 1; i < lines.length; i++) {
            const currentLine = lines[i].match(/(?:"[^"]*"|[^,])+/g);
            if (!currentLine || currentLine.length < 11) continue; 

            const obj = {};
            
            function parseNumber(index) {
                let value = (currentLine[index] || '0').trim().replace(/^"|"$/g, '');
                
                // 1. Удаляем все пробелы (разделители тысяч)
                value = value.replace(/\s/g, ''); 
                // 2. Удаляем знак доллара
                value = value.replace('$', ''); 
                // 3. Заменяем запятую (европейский десятичный разделитель) на точку
                value = value.replace(',', '.'); 
                
                return parseFloat(value) || 0;
            }

            obj.team = (currentLine[INDEX_TEAM] || 'Не указана').trim().replace(/^"|"$/g, '');
            obj.employee = (currentLine[INDEX_EMPLOYEE] || 'Не указан').trim().replace(/^"|"$/g, '');
            
            const rawDate = (currentLine[INDEX_DATE] || '').trim().replace(/^"|"$/g, '');
            obj.date = normalizeDate(rawDate); 
            
            // Чтение Spend и CPL
            obj.spend = parseNumber(INDEX_SPEND);
            obj.cpl = parseNumber(INDEX_CPL);

            // Чтение Leads и округление до целого числа (Math.round)
            obj.leads = Math.round(parseNumber(INDEX_LEADS)); 

            if (obj.spend === 0 && obj.leads === 0) continue; 
            
            result.push(obj);
        }
        return result;
    }

    async function fetchData() {
        loadingOverlay.style.display = 'flex';
        try {
            const response = await fetch(SHEETS_CSV_URL, { cache: 'no-cache' }); 
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const csvText = await response.text();
            rawData = csvToJSON(csvText);
            
            initDashboard();
        } catch (error) {
            console.error("Ошибка загрузки данных из Google Sheets:", error);
            loadingOverlay.innerText = `Ошибка загрузки данных. Проверьте доступ к таблице и консоль. (${error.message})`;
        }
    }


    // --- ЛОГИКА ДАШБОРДА ---

    function formatMoney(val) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(val);
    }
    
    function initDashboard() {
        dashboardContent.style.display = 'block';
        loadingOverlay.style.display = 'none';

        populateFilters();
        updateDashboard();
        
        // Event Listeners
        teamSelect.addEventListener('change', () => { 
            state.team = teamSelect.value; 
            state.employee = 'all'; 
            updateEmployeeDropdown(); 
            updateDashboard(); 
        });
        employeeSelect.addEventListener('change', () => { 
            state.employee = employeeSelect.value; 
            updateDashboard(); 
        });
        
        metricSelect.addEventListener('change', () => { state.metric = metricSelect.value; updateDashboard(); });
        startDateInput.addEventListener('change', () => { state.startDate = startDateInput.value; updateDashboard(); });
        endDateInput.addEventListener('change', () => { state.endDate = endDateInput.value; updateDashboard(); });

        clearInterval(window.dashboardInterval); 
        window.dashboardInterval = setInterval(fetchData, UPDATE_INTERVAL_MS);
    }

    function populateFilters() {
        // Команды
        const teams = [...new Set(rawData.map(d => d.team))].filter(Boolean).sort();
        teamSelect.innerHTML = '<option value="all">Все команды</option>';
        teams.forEach(t => {
            const opt = document.createElement('option');
            const cleanName = String(t).trim();
            opt.value = cleanName; 
            opt.textContent = cleanName; 
            teamSelect.appendChild(opt);
        });
        
        updateEmployeeDropdown();
    }

    function updateEmployeeDropdown() {
        employeeSelect.innerHTML = '<option value="all">Все сотрудники</option>';
        
        let filteredData = rawData;
        if (state.team !== 'all') {
            filteredData = rawData.filter(d => d.team === state.team);
        }
        
        const employees = [...new Set(filteredData.map(d => d.employee))].filter(Boolean).sort();
        employees.forEach(e => {
            const opt = document.createElement('option');
            const cleanEmployeeName = String(e).trim(); 
            opt.value = cleanEmployeeName;
            opt.textContent = cleanEmployeeName; 
            employeeSelect.appendChild(opt);
        });
        
        if (state.employee !== 'all' && employees.map(e => String(e).trim()).includes(state.employee)) {
             employeeSelect.value = state.employee;
        } else {
             state.employee = 'all';
             employeeSelect.value = 'all';
        }
    }

    function updateDashboard() {
        // 1. Filter Data (Team, Employee, Date)
        let filteredData = rawData.filter(d => {
            const matchTeam = state.team === 'all' || d.team === state.team;
            const matchEmp = state.employee === 'all' || d.employee === state.employee;
            
            let matchDate = true;
            if (d.date) {
                const rowDate = new Date(d.date);
                if (state.startDate) {
                    const start = new Date(state.startDate);
                    if (rowDate < start) matchDate = false;
                }
                if (state.endDate) {
                    const end = new Date(state.endDate);
                    const endDayInclusive = new Date(end);
                    endDayInclusive.setDate(endDayInclusive.getDate() + 1);
                    if (rowDate >= endDayInclusive) matchDate = false;
                }
            } else {
                if (state.startDate || state.endDate) matchDate = false;
            }
            
            return matchTeam && matchEmp && matchDate;
        });
        
        // 2. Aggregate Data (KPI)
        const totalSpend = filteredData.reduce((sum, d) => sum + (d.spend || 0), 0);
        const totalLeads = filteredData.reduce((sum, d) => sum + (d.leads || 0), 0);
        const avgCpl = totalLeads > 0 ? totalSpend / totalLeads : 0;
        const activeEmps = new Set(filteredData.map(d => d.employee)).size;

        // 3. Update KPI Cards
        document.getElementById('totalSpend').innerText = formatMoney(totalSpend);
        document.getElementById('totalLeads').innerText = totalLeads.toLocaleString('ru-RU');
        document.getElementById('avgCpl').innerText = formatMoney(avgCpl);
        document.getElementById('activeEmployees').innerText = activeEmps;
        
        // 4. Group data by Employee for Charts/Table
        const employeeSummary = {};
        
        filteredData.forEach(d => {
            const key = d.employee;
            
            if (!employeeSummary[key]) {
                employeeSummary[key] = {
                    key: key,
                    employee: d.employee,
                    team: d.team, 
                    spend: 0,
                    leads: 0,
                    dates: []
                };
            }
            employeeSummary[key].spend += d.spend;
            employeeSummary[key].leads += d.leads;
            if (d.date) employeeSummary[key].dates.push(d.date); 
        });

        let list = Object.values(employeeSummary).map(d => {
            const sortedDates = d.dates.sort();
            const minDate = sortedDates.length ? sortedDates[0] : 'N/A';
            const maxDate = sortedDates.length ? sortedDates[sortedDates.length - 1] : 'N/A';
            
            return {
                ...d,
                cpl: d.leads > 0 ? d.spend / d.leads : (d.spend > 0 ? Infinity : 0),
                date_range: minDate === maxDate ? minDate : `${minDate} - ${maxDate}`
            };
        }).filter(d => d.spend > 0 || d.leads > 0); 

        // 5. Sort by the selected metric for the bar chart
        if (state.metric === 'spend') list.sort((a, b) => b.spend - a.spend);
        else if (state.metric === 'leads') list.sort((a, b) => b.leads - a.leads);
        else list.sort((a, b) => {
            const cplA = isFinite(a.cpl) ? a.cpl : (a.spend > 0 ? 999999 : 0);
            const cplB = isFinite(b.cpl) ? b.cpl : (b.spend > 0 ? 999999 : 0);
            return cplA - cplB; 
        });
        
        // 6. Render Charts and Table
        renderBarChart(list);
        renderPieChart(list);
        renderTable(list); 
    }

    function renderBarChart(list) {
        const ctx = document.getElementById('mainBarChart').getContext('2d');
        const displayList = list.slice(0, 15); 
        
        const labels = displayList.map(d => d.key);
        let datasetData = [];
        let labelStr = '';
        let color = '';

        if (state.metric === 'spend') {
            datasetData = displayList.map(d => d.spend);
            labelStr = 'Расход ($)';
            color = '#6b84f9';
        } else if (state.metric === 'leads') {
            datasetData = displayList.map(d => d.leads);
            labelStr = 'Лиды';
            color = '#10b981';
        } else {
            datasetData = displayList.map(d => isFinite(d.cpl) ? d.cpl : (d.spend > 0 ? 100 : 0));
            labelStr = 'CPL ($)';
            color = '#f59e0b';
        }

        if (barChartInstance) barChartInstance.destroy();
        
        let titlePrefix = 'Топ 15 сотрудников';

        barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: labelStr,
                    data: datasetData,
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 0,
                    borderRadius: 8,
                    hoverBackgroundColor: '#ffffff20',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: `${titlePrefix} по ${labelStr.toLowerCase()}`, font: { size: 16, weight: '700' } }
                },
                scales: {
                    x: { grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                    y: { 
                        beginAtZero: true, 
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: {
                            callback: function(value, index, ticks) {
                                if (state.metric === 'cpl') {
                                    return formatMoney(value);
                                }
                                return value.toLocaleString('ru-RU');
                            }
                        }
                    } 
                }
            }
        });
    }

    function renderPieChart(list) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        
        const aggregateBy = 'team';
        const stats = {};

        list.forEach(e => {
            const key = e[aggregateBy];
            if (!stats[key]) stats[key] = 0;
            if (state.metric === 'leads') {
                stats[key] += (e.leads || 0);
            } else {
                stats[key] += (e.spend || 0);
            }
        });

        const sortedKeys = Object.keys(stats).filter(k => stats[k] > 0).sort((a,b) => stats[b] - stats[a]);
        const labels = sortedKeys;
        const dataValues = sortedKeys.map(k => stats[k]);
        
        let title = (state.metric === 'leads') ? 'Доля лидов по командам' : 'Доля расходов по командам';

        const bgColors = [
            '#6b84f9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
            '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#06b6d4'
        ];

        if (pieChartInstance) pieChartInstance.destroy();

        pieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: bgColors.slice(0, labels.length),
                    borderColor: '#22262b', 
                    borderWidth: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: title, font: { size: 16, weight: '700' } },
                    legend: { position: 'bottom', align: 'start' }
                }
            }
        });
    }

    function renderTable(list) {
        const thead = document.querySelector('#dataTable thead');
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        
        tableTitle.innerText = 'Сводная детализация по сотрудникам';
        
        // Гарантируем, что заголовки всегда верные для сводки по сотрудникам
        thead.innerHTML = `
            <tr>
                <th>Сотрудник</th>
                <th>Команда</th>
                <th>Расход ($)</th>
                <th>Лиды</th>
                <th>CPL ($)</th>
                <th>Период активности</th>
                <th>Эффективность</th>
            </tr>
        `;

        list.forEach(e => {
            const tr = document.createElement('tr');
            const cplValue = isFinite(e.cpl) ? e.cpl : (e.spend > 0 ? Infinity : 0);
            const { badgeClass, badgeText } = getEfficiencyStatus(cplValue, e.spend, e.leads);
            const cplDisplay = isFinite(cplValue) ? formatMoney(cplValue) : (e.spend > 0 ? 'Ошибка' : formatMoney(0));

            tr.innerHTML = `
                <td style="font-weight:600">${e.employee}</td>
                <td>${e.team}</td>
                <td>${formatMoney(e.spend)}</td>
                <td>${e.leads.toLocaleString('ru-RU')}</td>
                <td>${cplDisplay}</td>
                <td style="font-size:0.85rem; color:var(--text-secondary)">${e.date_range}</td>
                <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function getEfficiencyStatus(cplValue, spend, leads) {
        let badgeClass = 'bg-gray';
        let badgeText = '-'; 

        // 1. ОТЛИЧНО (Зеленый): CPL <= 0.25
        if (cplValue > 0 && cplValue <= 0.25) {
            badgeClass = 'bg-green';
            badgeText = 'Отлично';
        // 2. СРЕДНЕЕ ОПТИМАЛЬНОЕ (Желтый): CPL между 0.25 и 0.35
        } else if (cplValue > 0.25 && cplValue <= 0.35) {
            badgeClass = 'bg-yellow'; 
            badgeText = 'Среднее оптимальное';
        // 3. НИЗКАЯ (Красный): CPL > 0.35
        } else if (cplValue > 0.35 && isFinite(cplValue)) { 
            badgeClass = 'bg-red';
            badgeText = 'Низкая';
        // 4. КРИТИЧНО (Красный): Есть расход, но нет лидов
        } else if (spend > 0 && leads === 0) {
            badgeClass = 'bg-red';
            badgeText = 'Нет лидов';
        } 
        return { badgeClass, badgeText };
    }
    
    fetchData(); 
</script>

</body>
</html>
